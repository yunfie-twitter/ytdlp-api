# 複数タブ対策の実装戦略

## 概要
同一ユーザーから複数タブ・複数ウィンドウでの同時アクセスを防ぐ方法。

## アプローチ比較

### 1. **セッションベース** （推奨）
- セッションIDで1ユーザー1セッションに制限
- ブラウザを開き直すとリセット
- 複数タブはセッション共有のため自動制御可能

**メリット:**
- 実装が簡単
- ブラウザの標準機能と統合
- クロスタブ通信で検出可能

**デメリット:**
- タブを意図的に分離されると防げない
- 他タブの存在を検出するには JS が必要

### 2. **タブID + LocalStorage** （中程度）
- 各タブに UUID を割り当て
- LocalStorage でタブの存在を記録
- 複数の有効タブを検出

**メリット:**
- 複数タブの同時存在を確実に検出
- JavaScript で実時間検知

**デメリット:**
- LocalStorage 操作でトラッキング可能
- プライベートウィンドウでリセット

### 3. **サーバー側でアクティブセッション追跡** （最高セキュリティ）
- サーバーが各タブのアクティビティをトラッキング
- アクティブなセッション数を制限
- 新しいタブがアクセスした時に前のセッション無効化

**メリット:**
- 最も堅牢
- サーバー側で完全制御
- 不正アクセス検出も容易

**デメリット:**
- 実装複雑
- データベース操作増加

## 推奨実装：セッション + タブID + サーバー側追跡

```php
// 新規テーブル: active_sessions
// - session_id (PRIMARY)
// - token_id (FOREIGN KEY)
// - tab_id (UUID)
// - device_fp
// - created_at
// - last_activity_at

// ロジック:
// 1. 新規リクエスト → tab_id 生成
// 2. サーバーで既存 active_session があるか確認
// 3. あれば古いセッション無効化 or 拒否
// 4. 新規 active_session 作成
// 5. 定期的に last_activity_at 更新
```

## 実装の粒度

| 項目 | 実装コスト | セキュリティ | 推奨度 |
|------|----------|----------|--------|
| セッションのみ | ⭐ | ⭐⭐ | 基本的用途 |
| + タブID追跡 | ⭐⭐ | ⭐⭐⭐ | 標準 |
| + サーバー追跡 | ⭐⭐⭐ | ⭐⭐⭐⭐ | 高セキュリティ |
